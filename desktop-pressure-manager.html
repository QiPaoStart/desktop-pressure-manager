<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wallpaper Engine éŸ³ä¹æ’­æ”¾å™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            color: white;
            min-height: 100vh;
            overflow: hidden;
            position: relative;
            transition: background 1s ease;
        }

        #bgVideo {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: -1;
            display: none;
        }

        #bgImage {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: -1;
            display: none;
        }

        .control-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 10;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 10px;
            border-radius: 5px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .control-panel button {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .control-panel button:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .file-status {
            position: absolute;
            top: 60px;
            right: 20px;
            z-index: 10;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 0.8rem;
            max-width: 250px;
        }

        .draggable {
            position: absolute;
            border-radius: 15px;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            min-width: 300px;
            min-height: 200px;
            user-select: none;
            transition: all 0.3s;
        }

        .draggable.minimized {
            width: 60px !important;
            height: 60px !important;
            min-width: 60px;
            min-height: 60px;
            overflow: hidden;
        }

        .draggable-header {
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            cursor: move;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .draggable.minimized .draggable-header {
            padding: 5px;
            height: 100%;
            justify-content: center;
        }

        .draggable.minimized .draggable-header h3,
        .draggable.minimized .draggable-content {
            display: none;
        }

        .draggable-content {
            padding: 20px;
            height: calc(100% - 50px);
            overflow-y: auto;
        }

        .music-player {
            width: 350px;
            height: 600px;
            top: 50px;
            right: 500px;
        }

        .ai-chat {
            width: 400px;
            height: 450px;
            top: 50px;
            right: 50px;
        }

        .music-cover {
            width: 200px;
            height: 200px;
            margin: 0 auto 20px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(255, 255, 255, 0.5);
        }

        .music-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
        }

        .music-info {
            text-align: center;
            margin-bottom: 20px;
        }

        .music-title {
            font-size: 1.4rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .music-artist {
            font-size: 1rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .progress-container {
            margin: 20px 0;
        }

        .progress-bar {
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            position: relative;
        }

        .progress {
            height: 100%;
            background: #4CAF50;
            border-radius: 3px;
            width: 0%;
        }

        .time-display {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 5px;
        }

        .controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin: 20px 0;
        }

        .control-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .play-pause {
            background: #4CAF50;
            width: 50px;
            height: 50px;
            font-size: 1.5rem;
        }

        .play-pause:hover {
            background: #45a049;
            transform: scale(1.05);
        }

        .volume-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
            justify-content: center;
        }

        .volume-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .volume-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .volume-display {
            font-size: 0.9rem;
            min-width: 40px;
            text-align: center;
        }

        .playlist {
            margin-top: 20px;
            max-height: 150px;
            overflow-y: auto;
        }

        .playlist-item {
            padding: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .playlist-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .playlist-item.active {
            background: rgba(76, 175, 80, 0.3);
        }

        .playlist-item img {
            width: 40px;
            height: 40px;
            border-radius: 5px;
            object-fit: cover;
        }

        .chat-messages {
            height: 280px;
            overflow-y: auto;
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
        }

        .message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 10px;
            max-width: 80%;
        }

        .user-message {
            background: rgba(76, 175, 80, 0.3);
            margin-left: auto;
            text-align: right;
        }

        .ai-message {
            background: rgba(33, 150, 243, 0.3);
        }

        .chat-input {
            display: flex;
            gap: 10px;
        }

        .chat-input input {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            outline: none;
        }

        .chat-input button {
            background: #4CAF50;
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
        }

        .chat-input button:hover {
            background: #45a049;
            transform: scale(1.05);
        }

        .minimize-btn {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 1.2rem;
        }

        .minimized-icon {
            font-size: 1.5rem;
            text-align: center;
        }

        .music-icon::before {
            content: "ğŸµ";
        }

        .ai-icon::before {
            content: "ğŸ¤–";
        }

        .seek-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 10px 0;
        }

        .seek-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .seek-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
    </style>
</head>
<body>
    <!-- èƒŒæ™¯å…ƒç´  -->
    <video id="bgVideo" loop muted></video>
    <img id="bgImage" alt="èƒŒæ™¯å›¾ç‰‡">
    
    <!-- æ–‡ä»¶çŠ¶æ€æ˜¾ç¤º -->
    <!-- <div class="file-status" id="fileStatus">
        æ­£åœ¨åˆå§‹åŒ–...
    </div> -->

    <!-- æ§åˆ¶é¢æ¿ -->
    <!-- <div class="control-panel">
        <button id="loadConfigBtn">ğŸ“ åŠ è½½é…ç½®</button>
        <button id="exportConfigBtn">ğŸ’¾ å¯¼å‡ºé…ç½®</button>
    </div> -->

    <!-- éŸ³ä¹æ’­æ”¾å™¨ -->
    <div class="draggable music-player" id="musicPlayer">
        <div class="draggable-header">
            <h3>éŸ³ä¹æ’­æ”¾å™¨</h3>
            <button class="minimize-btn">âˆ’</button>
        </div>
        <div class="draggable-content">
            <div class="music-cover">
                <img id="coverImage" alt="ä¸“è¾‘å°é¢">
                <span>æ— å°é¢</span>
            </div>
            <div class="music-info">
                <div class="music-title" id="musicTitle">æš‚æ— æ­Œæ›²</div>
                <div class="music-artist" id="musicArtist">æœªçŸ¥è‰ºæœ¯å®¶</div>
            </div>
            <div class="progress-container">
                <div class="progress-bar" id="progressBar">
                    <div class="progress" id="progress"></div>
                </div>
                <div class="time-display">
                    <span id="currentTime">0:00</span>
                    <span id="duration">0:00</span>
                </div>
            </div>
            <div class="seek-buttons">
                <button class="seek-btn" id="seekBackBtn">-10ç§’</button>
                <button class="seek-btn" id="seekForwardBtn">+10ç§’</button>
            </div>
            <div class="controls">
                <button class="control-btn" id="prevBtn">â®</button>
                <button class="control-btn play-pause" id="playPauseBtn">â–¶</button>
                <button class="control-btn" id="nextBtn">â­</button>
            </div>
            <div class="volume-control">
                <button class="volume-btn" id="volumeDownBtn">âˆ’</button>
                <span class="volume-display" id="volumeDisplay">50%</span>
                <button class="volume-btn" id="volumeUpBtn">+</button>
            </div>
        </div>
    </div>

    <!-- AIèŠå¤©æ¨¡å— -->
    <div class="draggable ai-chat" id="aiChat">
        <div class="draggable-header">
            <h3>AIå¿ƒæƒ…åŠ©æ‰‹</h3>
            <button class="minimize-btn">âˆ’</button>
        </div>
        <div class="draggable-content">
            <div class="chat-messages" id="chatMessages">
                <div class="message ai-message">
                    ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„AIå¿ƒæƒ…åŠ©æ‰‹ã€‚
                </div>
            </div>
            <div class="chat-input">
                <input type="text" id="chatInput" placeholder="è¾“å…¥ä½ çš„é—®é¢˜...">
                <button id="sendBtn">â¤</button>
            </div>
        </div>
    </div>

    <!-- éŸ³é¢‘å…ƒç´  -->
    <audio id="audioPlayer"></audio>

    <script>
        // DOMå…ƒç´ 
        const musicPlayer = document.getElementById('musicPlayer');
        const aiChat = document.getElementById('aiChat');
        const audioPlayer = document.getElementById('audioPlayer');
        const coverImage = document.getElementById('coverImage');
        const musicTitle = document.getElementById('musicTitle');
        const musicArtist = document.getElementById('musicArtist');
        const progressBar = document.getElementById('progressBar');
        const progress = document.getElementById('progress');
        const currentTime = document.getElementById('currentTime');
        const duration = document.getElementById('duration');
        const playPauseBtn = document.getElementById('playPauseBtn');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const volumeDownBtn = document.getElementById('volumeDownBtn');
        const volumeUpBtn = document.getElementById('volumeUpBtn');
        const volumeDisplay = document.getElementById('volumeDisplay');
        const playlist = document.getElementById('playlist');
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const sendBtn = document.getElementById('sendBtn');
        // const fileStatus = document.getElementById('fileStatus');
        const bgVideo = document.getElementById('bgVideo');
        const bgImage = document.getElementById('bgImage');
        // const loadConfigBtn = document.getElementById('loadConfigBtn');
        // const exportConfigBtn = document.getElementById('exportConfigBtn');
        const seekBackBtn = document.getElementById('seekBackBtn');
        const seekForwardBtn = document.getElementById('seekForwardBtn');

        // åº”ç”¨çŠ¶æ€
        let currentMusicIndex = 0;
        let isPlaying = false;
        let isDragging = false;
        let currentDraggable = null;
        let offsetX, offsetY;
        
        // æ–‡ä»¶åˆ—è¡¨
        let musicFiles = [];
        let backgroundColors = [];
        let backgroundImages = [];
        let backgroundVideos = [];
        let currentBgIndex = 0;
        let currentBgType = 'color';

        // é…ç½®æ–‡ä»¶å
        const CONFIG_FILE = 'config.json';

        //DeepSeek API Key
        let DEEPSEEK_API_KEY = '';

        // åˆå§‹åŒ–
        function init() {
            setupEventListeners();
            loadConfig();
            initAIChat();
            
            // è®¾ç½®åˆå§‹èƒŒæ™¯
            document.body.style.background = 'linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d)';
            
            // è®¾ç½®åˆå§‹éŸ³é‡
            audioPlayer.volume = 0.5;
            updateVolumeDisplay();
            
            // fileStatus.textContent = "ç­‰å¾…Wallpaper Engineå±æ€§é…ç½®...";
        }

        // Wallpaper Engine å±æ€§ç›‘å¬å™¨
        window.wallpaperPropertyListener = {
            applyUserProperties: function(properties) {
                // å¤„ç†è‡ªå®šä¹‰èƒŒæ™¯
                if (properties.custombackground) {
                    if (properties.custombackground.value) {
                        const backgroundFile = 'file:///' + properties.custombackground.value;
                        // fileStatus.textContent = "åŠ è½½è‡ªå®šä¹‰èƒŒæ™¯...";
                        
                        // æ£€æŸ¥æ–‡ä»¶ç±»å‹
                        if (backgroundFile.match(/\.(mp4|webm|ogg|ogv)$/i)) {
                            // è§†é¢‘èƒŒæ™¯
                            bgVideo.src = backgroundFile;
                            bgVideo.style.display = 'block';
                            bgImage.style.display = 'none';
                            document.body.style.background = 'none';
                            currentBgType = 'video';
                        } else if (backgroundFile.match(/\.(jpg|jpeg|png|gif|bmp|webp)$/i)) {
                            // å›¾ç‰‡èƒŒæ™¯
                            bgImage.src = backgroundFile;
                            bgImage.style.display = 'block';
                            bgVideo.style.display = 'none';
                            document.body.style.background = 'none';
                            currentBgType = 'image';
                        }
                    } else {
                        // æ²¡æœ‰è‡ªå®šä¹‰èƒŒæ™¯ï¼Œä½¿ç”¨é»˜è®¤é¢œè‰²
                        bgVideo.style.display = 'none';
                        bgImage.style.display = 'none';
                        currentBgType = 'color';
                        if (backgroundColors.length > 0) {
                            document.body.style.background = backgroundColors[currentBgIndex];
                        }
                    }
                }
                
                // å¤„ç†éŸ³ä¹ç›®å½•
                if (properties.musicdirectory) {
                    if (properties.musicdirectory.value) {
                        // fileStatus.textContent = "æ‰«æéŸ³ä¹ç›®å½•...";
                        // åœ¨å®é™…ä½¿ç”¨ä¸­ï¼Œè¿™é‡Œåº”è¯¥ä½¿ç”¨Wallpaper Engineçš„APIæ¥è·å–ç›®å½•ä¸­çš„æ–‡ä»¶
                        // ç”±äºæ— æ³•ç›´æ¥åˆ—å‡ºç›®å½•ï¼Œæˆ‘ä»¬å‡è®¾ç”¨æˆ·å·²ç»é€šè¿‡å…¶ä»–æ–¹å¼é…ç½®äº†éŸ³ä¹æ–‡ä»¶
                        setTimeout(() => {
                            // fileStatus.textContent = "éŸ³ä¹ç›®å½•å·²åŠ è½½";
                        }, 1000);
                    } else {
                        // fileStatus.textContent = "æœªè®¾ç½®éŸ³ä¹ç›®å½•";
                    }
                }

                //å¤„ç†AIéƒ¨åˆ†
                if (properties.deepseekapikey) {
                    DEEPSEEK_API_KEY = properties.deepseekapikey.value;
                }
                if (properties.messagecontents) {
                    chatInput.value = properties.messagecontents.value;
                }
            },
            
            userDirectoryFilesAddedOrChanged: function(propertyName, changedFiles) {
                if (propertyName === 'musicdirectory') {
                    // å¤„ç†æ–°å¢æˆ–æ›´æ”¹çš„éŸ³ä¹æ–‡ä»¶
                    changedFiles.forEach(filePath => {
                        const fileName = filePath.split('/').pop().split('\\').pop();
                        const title = fileName.replace(/\.[^/.]+$/, ""); // ç§»é™¤æ‰©å±•å
                        
                        // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
                        if (!musicFiles.some(music => music.src === filePath)) {
                            musicFiles.push({
                                title: title,
                                artist: "æœªçŸ¥è‰ºæœ¯å®¶",
                                src: filePath,
                                cover: null
                            });
                        }
                    });
                    
                    renderPlaylist();
                    updateFileStatus();
                    
                    if (musicFiles.length > 0 && currentMusicIndex < musicFiles.length) {
                        loadMusic(currentMusicIndex);
                    }
                }
            },
            
            userDirectoryFilesRemoved: function(propertyName, removedFiles) {
                if (propertyName === 'musicdirectory') {
                    // å¤„ç†ç§»é™¤çš„éŸ³ä¹æ–‡ä»¶
                    removedFiles.forEach(filePath => {
                        musicFiles = musicFiles.filter(music => music.src !== filePath);
                    });
                    
                    renderPlaylist();
                    updateFileStatus();
                    
                    if (musicFiles.length > 0) {
                        if (currentMusicIndex >= musicFiles.length) {
                            currentMusicIndex = 0;
                        }
                        loadMusic(currentMusicIndex);
                    } else {
                        musicTitle.textContent = "æš‚æ— æ­Œæ›²";
                        musicArtist.textContent = "è¯·æ·»åŠ éŸ³ä¹æ–‡ä»¶";
                    }
                }
            }
        };

        // åŠ è½½é…ç½®æ–‡ä»¶
        function loadConfig() {
            // fileStatus.textContent = "æ­£åœ¨åŠ è½½é…ç½®æ–‡ä»¶...";
            
            // å°è¯•ä»JSONæ–‡ä»¶åŠ è½½é…ç½®
            fetch(CONFIG_FILE)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('é…ç½®æ–‡ä»¶ä¸å­˜åœ¨æˆ–æ— æ³•è®¿é—®');
                    }
                    return response.json();
                })
                .then(config => {
                    // ä½¿ç”¨é…ç½®æ–‡ä»¶ä¸­çš„æ•°æ®
                    musicFiles = config.musicFiles || [];
                    backgroundColors = config.backgroundColors || [];
                    backgroundImages = config.backgroundImages || [];
                    backgroundVideos = config.backgroundVideos || [];
                    
                    // åŠ è½½çª—å£ä½ç½®
                    if (config.windowPositions) {
                        if (config.windowPositions.musicPlayer) {
                            musicPlayer.style.left = config.windowPositions.musicPlayer.left;
                            musicPlayer.style.top = config.windowPositions.musicPlayer.top;
                        }
                        if (config.windowPositions.aiChat) {
                            aiChat.style.left = config.windowPositions.aiChat.left;
                            aiChat.style.top = config.windowPositions.aiChat.top;
                        }
                    }
                    
                    updateFileStatus();
                    
                    if (musicFiles.length > 0) {
                        loadMusic(0);
                        renderPlaylist();
                    } else {
                        musicTitle.textContent = "æš‚æ— éŸ³ä¹æ–‡ä»¶";
                        musicArtist.textContent = "è¯·é€šè¿‡Wallpaper Engineå±æ€§æ·»åŠ éŸ³ä¹";
                    }
                    
                    // fileStatus.textContent = "é…ç½®æ–‡ä»¶åŠ è½½æˆåŠŸ";
                })
                .catch(error => {
                    console.error('åŠ è½½é…ç½®æ–‡ä»¶å¤±è´¥:', error);
                    // fileStatus.textContent = "é…ç½®æ–‡ä»¶åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤é…ç½®";
                    
                    // ä½¿ç”¨é»˜è®¤é…ç½®
                    setDefaultConfig();
                });
        }

        // è®¾ç½®é»˜è®¤é…ç½®
        function setDefaultConfig() {
            musicFiles = [
                {
                    title: "æœˆå…‰å¥é¸£æ›²",
                    artist: "è´å¤šèŠ¬",
                    cover: "https://picsum.photos/200/200?random=2",
                    src: "https://m801.music.126.net/20251118161702/8e4712b8882f25070871db3cac80db42/jdymusic/obj/wo3DlMOGwrbDjj7DisKw/15889498932/795f/2682/1dc6/4887dc93ea2b1d85a4c7e297d0a862bd.mp3"
                },
                {
                    title: "Liyue ç’ƒæœˆ",
                    artist: "é™ˆè‡´é€¸, HOYO-MIX",
                    cover: "D:/SteamPowered/steamapps/common/wallpaper_engine/projects/myprojects/deepseek-work-v1/liyue.jpg",
                    src: "D:/SteamPowered/steamapps/common/wallpaper_engine/projects/myprojects/deepseek-work-v1/é™ˆè‡´é€¸,HOYO-MiX - Liyue ç’ƒæœˆ.mp3"
                }
            ];
            
            backgroundColors = [
                'linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d)',
                'linear-gradient(135deg, #667eea, #764ba2)',
                'linear-gradient(135deg, #f093fb, #f5576c)',
                'linear-gradient(135deg, #4facfe, #00f2fe)',
                'linear-gradient(135deg, #43e97b, #38f9d7)'
            ];
            
            backgroundImages = [];
            backgroundVideos = [];
            
            updateFileStatus();
            
            if (musicFiles.length > 0) {
                loadMusic(0);
                renderPlaylist();
            }
        }

        // ä¿å­˜é…ç½®åˆ°JSONæ–‡ä»¶
        function saveConfig() {
            const config = {
                musicFiles: musicFiles,
                backgroundColors: backgroundColors,
                backgroundImages: backgroundImages,
                backgroundVideos: backgroundVideos,
                windowPositions: {
                    musicPlayer: {
                        left: musicPlayer.style.left,
                        top: musicPlayer.style.top
                    },
                    aiChat: {
                        left: aiChat.style.left,
                        top: aiChat.style.top
                    }
                }
            };
            
            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(config, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", CONFIG_FILE);
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
            
            // fileStatus.textContent = "é…ç½®å·²ä¿å­˜å¹¶å‡†å¤‡ä¸‹è½½";
        }

        // æ›´æ–°æ–‡ä»¶çŠ¶æ€æ˜¾ç¤º
        function updateFileStatus() {
            let status = `éŸ³ä¹: ${musicFiles.length} é¦–, `;
            status += `é¢œè‰²: ${backgroundColors.length} ç§, `;
            status += `å›¾ç‰‡: ${backgroundImages.length} å¼ , `;
            status += `è§†é¢‘: ${backgroundVideos.length} ä¸ª`;
            // fileStatus.textContent = status;
        }

        // åœ¨æ–‡ä»¶å¼€å¤´æ·»åŠ DeepSeek APIé…ç½®
        const DEEPSEEK_API_URL = 'https://api.deepseek.com/chat/completions';

        // ç³»ç»Ÿæç¤ºè¯
        const SYSTEM_PROMPT = `ä½ æ˜¯ä¸€ä¸ªé›†æˆåœ¨æ¡Œé¢ä¸­çš„AIå¿ƒæƒ…åŠ©æ‰‹ï¼Œè´Ÿè´£å¸®åŠ©ç”¨æˆ·è°ƒæ•´å¿ƒæƒ…ã€‚ç”¨æˆ·çš„ç‰¹ç‚¹æ˜¯ï¼š
        1. æ˜¯åŒ—äº¬èˆªç©ºèˆªå¤©å¤§å­¦çš„ä¸€åå¤§å­¦ç”Ÿï¼Œè¯¾ä¸šå¯èƒ½ç¹å¿™ï¼Œå­¦ä¹ å‹åŠ›å¯èƒ½è¾ƒå¤§
        2. æ›´å¯èƒ½æ˜¯ä¸€åç†ç§‘æˆ–å·¥ç§‘å­¦ç”Ÿï¼Œå­¦ä¹ èƒ½åŠ›è¾ƒå¼ºï¼Œä½†é‡è§†é€»è¾‘æ€è€ƒï¼Œå¯èƒ½æ— æ³•è‰¯å¥½æ§åˆ¶æƒ…æ„Ÿ
        ä½ çš„ç‰¹ç‚¹æ˜¯ï¼š
        1. å‹å¥½ã€çƒ­æƒ…ä¸”ä¹äºåŠ©äºº
        2. å¯ä»¥æ ¹æ®ç”¨æˆ·æä¾›çš„å½“å¤©å‘ç”Ÿçš„äº‹æƒ…åŠä»–/å¥¹çš„æ„Ÿå—æä¾›è´´å¿ƒçš„å®‰æ…°å¹¶æå‡ºç›¸å…³é—®é¢˜æœ‰æ•ˆçš„è§£å†³æ–¹æ¡ˆ
        3. å›ç­”ç®€æ´æ˜äº†ï¼Œé€‚åˆåœ¨èŠå¤©ç•Œé¢æ˜¾ç¤º`;

        // ä¿®æ”¹AIèŠå¤©æ¨¡å—çš„åˆå§‹åŒ–
        function initAIChat() {
            // æ¸…ç©ºåŸæœ‰æ¶ˆæ¯ï¼Œæ·»åŠ AIçš„åˆå§‹é—®å€™
            chatMessages.innerHTML = '';
            addMessage('ä½ å¥½ï¼ä»Šå¤©çš„æ„Ÿå—æ€ä¹ˆæ ·ï¼Ÿæœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®å¿™çš„å—ï¼Ÿ', 'ai');
        }

        // åŠ è½½éŸ³ä¹
        function loadMusic(index) {
            if (musicFiles.length === 0) return;
            
            const music = musicFiles[index];
            
            // ä½¿ç”¨Wallpaper Engineçš„æ–‡ä»¶è·¯å¾„æ ¼å¼
            if(music.src.startsWith("https")) audioPlayer.src = music.src;
            else audioPlayer.src = 'file:///' + music.src;
            
            // å°è¯•åŠ è½½å°é¢å›¾ç‰‡
            if (music.cover) {
                if(music.src.startsWith("https")) coverImage.src = music.cover;
                else coverImage.src = 'file:///' + music.cover;
                coverImage.onload = function() {
                    coverImage.style.display = 'block';
                    document.querySelector('.music-cover span').style.display = 'none';
                };
                coverImage.onerror = function() {
                    coverImage.style.display = 'none';
                    document.querySelector('.music-cover span').style.display = 'block';
                };
            } else {
                coverImage.style.display = 'none';
                document.querySelector('.music-cover span').style.display = 'block';
            }
            
            musicTitle.textContent = music.title;
            musicArtist.textContent = music.artist;
            
            // æ›´æ–°æ’­æ”¾åˆ—è¡¨é«˜äº®
            const playlistItems = document.querySelectorAll('.playlist-item');
            playlistItems.forEach((item, i) => {
                if (i === index) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
        }

        // æ¸²æŸ“æ’­æ”¾åˆ—è¡¨
        function renderPlaylist() {
            playlist.innerHTML = '';
            musicFiles.forEach((music, index) => {
                const item = document.createElement('div');
                item.className = `playlist-item ${index === currentMusicIndex ? 'active' : ''}`;
                item.innerHTML = `
                    <div>
                        <div>${music.title}</div>
                        <div style="font-size: 0.8rem; color: rgba(255,255,255,0.7)">${music.artist}</div>
                    </div>
                `;
                item.addEventListener('click', () => {
                    currentMusicIndex = index;
                    loadMusic(index);
                    playMusic();
                });
                playlist.appendChild(item);
            });
        }

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // éŸ³é¢‘äº‹ä»¶
            audioPlayer.addEventListener('loadedmetadata', () => {
                duration.textContent = formatTime(audioPlayer.duration);
            });
            
            audioPlayer.addEventListener('timeupdate', () => {
                updateProgress();
            });
            
            audioPlayer.addEventListener('ended', () => {
                playNext();
            });
            
            // æ’­æ”¾æ§åˆ¶
            playPauseBtn.addEventListener('click', togglePlay);
            prevBtn.addEventListener('click', playPrev);
            nextBtn.addEventListener('click', playNext);
            
            // éŸ³é‡æ§åˆ¶
            volumeDownBtn.addEventListener('click', decreaseVolume);
            volumeUpBtn.addEventListener('click', increaseVolume);
            
            // è¿›åº¦æ§åˆ¶
            seekBackBtn.addEventListener('click', () => seek(-10));
            seekForwardBtn.addEventListener('click', () => seek(10));
            
            // AIèŠå¤©
            sendBtn.addEventListener('click', sendMessage);
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
            
            // é…ç½®æŒ‰é’®
            // loadConfigBtn.addEventListener('click', loadConfig);
            // exportConfigBtn.addEventListener('click', saveConfig);
            
            // æ‹–æ‹½åŠŸèƒ½
            setupDraggable(musicPlayer);
            setupDraggable(aiChat);
            
            // æœ€å°åŒ–æŒ‰é’®
            document.querySelectorAll('.minimize-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const draggable = e.target.closest('.draggable');
                    toggleMinimize(draggable);
                });
            });
            
            // èƒŒæ™¯å¾ªç¯ - æ¯30ç§’åˆ‡æ¢ä¸€æ¬¡èƒŒæ™¯
            setInterval(changeBackground, 30000);
        }

        // æ’­æ”¾/æš‚åœ
        function togglePlay() {
            if (isPlaying) {
                pauseMusic();
            } else {
                playMusic();
            }
        }

        // æ’­æ”¾éŸ³ä¹
        function playMusic() {
            if (musicFiles.length === 0) return;
            audioPlayer.play();
            isPlaying = true;
            playPauseBtn.textContent = 'â¸';
        }

        // æš‚åœéŸ³ä¹
        function pauseMusic() {
            audioPlayer.pause();
            isPlaying = false;
            playPauseBtn.textContent = 'â–¶';
        }

        // æ’­æ”¾ä¸Šä¸€é¦–
        function playPrev() {
            if (musicFiles.length === 0) return;
            currentMusicIndex = (currentMusicIndex - 1 + musicFiles.length) % musicFiles.length;
            loadMusic(currentMusicIndex);
            playMusic();
        }

        // æ’­æ”¾ä¸‹ä¸€é¦–
        function playNext() {
            if (musicFiles.length === 0) return;
            currentMusicIndex = (currentMusicIndex + 1) % musicFiles.length;
            loadMusic(currentMusicIndex);
            playMusic();
        }

        // è°ƒæ•´éŸ³é‡
        function increaseVolume() {
            if (audioPlayer.volume < 1) {
                audioPlayer.volume = Math.min(1, audioPlayer.volume + 0.1);
                updateVolumeDisplay();
            }
        }

        function decreaseVolume() {
            if (audioPlayer.volume > 0) {
                audioPlayer.volume = Math.max(0, audioPlayer.volume - 0.1);
                updateVolumeDisplay();
            }
        }

        // æ›´æ–°éŸ³é‡æ˜¾ç¤º
        function updateVolumeDisplay() {
            volumeDisplay.textContent = Math.round(audioPlayer.volume * 100) + '%';
        }

        // è·³è½¬è¿›åº¦
        function seek(seconds) {
            if (audioPlayer.duration) {
                audioPlayer.currentTime = Math.max(0, Math.min(audioPlayer.duration, audioPlayer.currentTime + seconds));
            }
        }

        // æ›´æ–°è¿›åº¦æ¡
        function updateProgress() {
            if (audioPlayer.duration) {
                const percent = (audioPlayer.currentTime / audioPlayer.duration) * 100;
                progress.style.width = `${percent}%`;
                currentTime.textContent = formatTime(audioPlayer.currentTime);
            }
        }

        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(seconds) {
            if (isNaN(seconds)) return "0:00";
            const min = Math.floor(seconds / 60);
            const sec = Math.floor(seconds % 60);
            return `${min}:${sec < 10 ? '0' : ''}${sec}`;
        }

        // å‘é€æ¶ˆæ¯
        async function sendMessage() {
            const message = chatInput.value.trim();
            if (!message) return;
            
            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            addMessage(message, 'user');
            chatInput.value = '';
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const loadingMessage = document.createElement('div');
            loadingMessage.className = 'message ai-message';
            loadingMessage.textContent = 'æ­£åœ¨æ€è€ƒ...';
            loadingMessage.id = 'loadingMessage';
            chatMessages.appendChild(loadingMessage);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            try {
                // å‡†å¤‡å¯¹è¯å†å²
                const messages = [
                    { role: 'system', content: SYSTEM_PROMPT },
                    { role: 'user', content: message }
                ];
                
                // è°ƒç”¨DeepSeek API
                const response = await fetch(DEEPSEEK_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${DEEPSEEK_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: 'deepseek-chat',
                        messages: messages,
                        temperature: 0.7,
                        max_tokens: 500,
                        stream: false
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);
                }
                
                const data = await response.json();
                
                // ç§»é™¤åŠ è½½æ¶ˆæ¯
                document.getElementById('loadingMessage')?.remove();
                
                // æ·»åŠ AIå›å¤
                if (data.choices && data.choices[0] && data.choices[0].message) {
                    const aiResponse = data.choices[0].message.content;
                    addMessage(aiResponse, 'ai');
                } else {
                    throw new Error('æ— æ•ˆçš„APIå“åº”æ ¼å¼');
                }
                
            } catch (error) {
                console.error('è°ƒç”¨DeepSeek APIå¤±è´¥:', error);
                
                // ç§»é™¤åŠ è½½æ¶ˆæ¯
                document.getElementById('loadingMessage')?.remove();
                
                // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
                let errorMessage = 'æŠ±æ­‰ï¼Œæˆ‘ç°åœ¨æ— æ³•å›å¤ã€‚è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•ã€‚';
                
                if (error.message.includes('APIå¯†é’¥') || error.message.includes('401')) {
                    errorMessage = 'APIé…ç½®é”™è¯¯ï¼Œè¯·æ£€æŸ¥DeepSeek APIå¯†é’¥æ˜¯å¦æ­£ç¡®è®¾ç½®ã€‚';
                } else if (error.message.includes('ç½‘ç»œ') || error.message.includes('Failed to fetch')) {
                    errorMessage = 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ‚¨çš„ç½‘ç»œè®¾ç½®ã€‚';
                }
                
                addMessage(errorMessage, 'ai');
            }
        }

        // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©çª—å£
        function addMessage(text, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;
            messageDiv.textContent = text;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // åˆ‡æ¢èƒŒæ™¯
        function changeBackground() {
            // å¾ªç¯åˆ‡æ¢èƒŒæ™¯ç±»å‹: color -> image -> video -> color
            if (properties.custombackground){
                if(currentBgType == 'image') return;
                const randomImage = backgroundImages[Math.floor(Math.random() * backgroundImages.length)];
                bgImage.src = 'file:///' + randomImage;
                bgImage.style.display = 'block';
                bgVideo.style.display = 'none';
                document.body.style.background = 'none';
                currentBgType = 'image';
                return;
            }
            if (currentBgType === 'color') {
                if (backgroundImages.length > 0) {
                    // åˆ‡æ¢åˆ°å›¾ç‰‡èƒŒæ™¯
                    const randomImage = backgroundImages[Math.floor(Math.random() * backgroundImages.length)];
                    bgImage.src = 'file:///' + randomImage;
                    bgImage.style.display = 'block';
                    bgVideo.style.display = 'none';
                    document.body.style.background = 'none';
                    currentBgType = 'image';
                } else if (backgroundVideos.length > 0) {
                    // å¦‚æœæ²¡æœ‰å›¾ç‰‡ä½†æœ‰è§†é¢‘ï¼Œåˆ‡æ¢åˆ°è§†é¢‘
                    const randomVideo = backgroundVideos[Math.floor(Math.random() * backgroundVideos.length)];
                    bgVideo.src = 'file:///' + randomVideo;
                    bgVideo.style.display = 'block';
                    bgImage.style.display = 'none';
                    document.body.style.background = 'none';
                    currentBgType = 'video';
                } else if (backgroundColors.length > 0) {
                    // å¦‚æœæ²¡æœ‰å›¾ç‰‡å’Œè§†é¢‘ï¼Œåˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªé¢œè‰²
                    currentBgIndex = (currentBgIndex + 1) % backgroundColors.length;
                    document.body.style.background = backgroundColors[currentBgIndex];
                    bgImage.style.display = 'none';
                    bgVideo.style.display = 'none';
                }
            } else if (currentBgType === 'image') {
                if (backgroundVideos.length > 0) {
                    // åˆ‡æ¢åˆ°è§†é¢‘èƒŒæ™¯
                    const randomVideo = backgroundVideos[Math.floor(Math.random() * backgroundVideos.length)];
                    bgVideo.src = 'file:///' + randomVideo;
                    bgVideo.style.display = 'block';
                    bgImage.style.display = 'none';
                    document.body.style.background = 'none';
                    currentBgType = 'video';
                } else if (backgroundColors.length > 0) {
                    // å¦‚æœæ²¡æœ‰è§†é¢‘ï¼Œåˆ‡æ¢åˆ°é¢œè‰²èƒŒæ™¯
                    currentBgIndex = (currentBgIndex + 1) % backgroundColors.length;
                    document.body.style.background = backgroundColors[currentBgIndex];
                    bgImage.style.display = 'none';
                    bgVideo.style.display = 'none';
                    currentBgType = 'color';
                }
            } else if (currentBgType === 'video') {
                if (backgroundColors.length > 0) {
                    // åˆ‡æ¢åˆ°é¢œè‰²èƒŒæ™¯
                    currentBgIndex = (currentBgIndex + 1) % backgroundColors.length;
                    document.body.style.background = backgroundColors[currentBgIndex];
                    bgImage.style.display = 'none';
                    bgVideo.style.display = 'none';
                    currentBgType = 'color';
                }
            }
        }

        // è®¾ç½®å¯æ‹–æ‹½å…ƒç´ 
        function setupDraggable(element) {
            const header = element.querySelector('.draggable-header');
            
            header.addEventListener('mousedown', (e) => {
                isDragging = true;
                currentDraggable = element;
                offsetX = e.clientX - element.offsetLeft;
                offsetY = e.clientY - element.offsetTop;
                
                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            });
        }

        // é¼ æ ‡ç§»åŠ¨äº‹ä»¶
        function onMouseMove(e) {
            if (!isDragging || !currentDraggable) return;
            
            const x = e.clientX - offsetX;
            const y = e.clientY - offsetY;
            
            // é™åˆ¶åœ¨è§†çª—å†…
            const maxX = window.innerWidth - currentDraggable.offsetWidth;
            const maxY = window.innerHeight - currentDraggable.offsetHeight;
            
            currentDraggable.style.left = `${Math.max(0, Math.min(x, maxX))}px`;
            currentDraggable.style.top = `${Math.max(0, Math.min(y, maxY))}px`;
        }

        // é¼ æ ‡é‡Šæ”¾äº‹ä»¶
        function onMouseUp() {
            isDragging = false;
            currentDraggable = null;
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
            
            // ä¿å­˜çª—å£ä½ç½®
            saveConfig();
        }

        // åˆ‡æ¢æœ€å°åŒ–çŠ¶æ€
        function toggleMinimize(element) {
            element.classList.toggle('minimized');
            
            if (element.classList.contains('minimized')) {
                // æ·»åŠ å›¾æ ‡
                const header = element.querySelector('.draggable-header');
                if (!header.querySelector('.minimized-icon')) {
                    const icon = document.createElement('div');
                    icon.className = 'minimized-icon';
                    if (element.id === 'musicPlayer') {
                        icon.classList.add('music-icon');
                    } else if (element.id === 'aiChat') {
                        icon.classList.add('ai-icon');
                    }
                    header.appendChild(icon);
                }
            } else {
                // ç§»é™¤å›¾æ ‡
                const icon = element.querySelector('.minimized-icon');
                if (icon) {
                    icon.remove();
                }
            }
        }

        // åˆå§‹åŒ–åº”ç”¨
        init();
    </script>
</body>
</html>